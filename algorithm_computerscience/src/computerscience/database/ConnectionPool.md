# *DataBase Connection Pool(DBCP)*, 데이터베이스 풀

## *🔗 Connection Pool* 이란?

---

클라이언트의 요청에 따라 각 애플리케이션의 스레드에서 DB로 접근하기 위해서는 Connection이 필요하다.

***Connection Pool*** 은 ***DB와 미리 Connection 을 해놓은 객체들을 Pool(캐시)에 저장*** 한다.

- 이후, 클라이언트의 요청이 오면 Connection 을 꺼내 쓰고 반환한다.

## 👍 Connection Pool 을 사용하는 이유

---

먼저 *Connection Pool* 을 사용하지 않는 웹 애플리케이션의 처리 과정을 살펴보자.

1. 웹 애플리케이션은 클라이언트의 HTTP 요청이 들어오면 쓰레드를 생성한다.
2. 대부분의 비즈니스 로직에서는 DB 서버로부터 데이터를 얻어서 해당 요청을 처리해준다.
3. DB 서버로부터 데이터를 얻기 위해서는 물리적으로 DB 서버에 지속적으로 접근하는 작업이 필요하다.

⚠️ 즉, 클라이언트는 매 요청 시 드라이버를 로드하고 Connection 객체를 생성 및 종료를 해야 한다.

이렇게 DB 서버에 지속적으로 Connection 객체를 생성하는 작업은 ***비용적, 성능적으로 저하를 야기*** 한다.

- *`Out of memory`* 의 주된 원인이 되기도 한다.

### *Connection Pool* 이 *DataBase* 에 접근하는 과정

![Untitled](https://prod-files-secure.s3.us-west-2.amazonaws.com/c33fee58-8f40-4523-b222-c56099de30a9/cab4977d-da29-4f20-af15-c29ed3729ef3/Untitled.png)

---

*Connection Pool* 은 다음과 같은 방식으로 DB에 접근한다.

1. WAS(웹 컨테이너)가 실행되면서 *DB와 연결된 Connection 객체들을 미리 생성해서 Pool 에 저장* 한다.
2. 클라이언트가 DB에 요청하게 되면, *Pool 에서 Connection 객체를 가져와* 서 DB에 접근한다.
3. 모든 처리 과정이 끝나면 다시 *Connection 객체를 Pool 에 반환* 한다.

위와 같은 방식으로 물리적인 DB Connection, 연결 부하를 줄이고 연결을 관리한다.

- Pool 에 미리 Connection 객체가 생성되어 있기 때문에, 생성 비용과 시간이 소비되지 않는다.
- 또한, Connection 을 계속해서 재사용하기 때문에 생성되는 Connection 수를 제한적으로 설정한다.

<aside>
📌 즉, Connection Pool 사용 이유는 DBCP로 이미 연결된 Connection 객체들을 ***재사용*** 하는 것이다.

</aside>

## *🏊🏻 Thread Pool* 이란?

---

마찬가지로, *Thread Pool* 은 *Connection Pool* 처럼 일정 개수의 쓰레드를 미리 생성하여 관리하는 기법이다.

- Thread Pool 역시 매 요청마다 요청을 처리할 쓰레드를 생성하는 것이 아닌,
- Pool 에 미리 생성한 쓰레드를 소멸시키지 않고, 재사용하여 효율적으로 자원을 활용하게 된다.

### Thread Pool 을 사용하는 이유

---

서버에는 여러 클라이언트들이 동시에 접속할 수 있는데, 자바에서는 쓰레드를 운영 체제의 자원으로 사용한다.

- 접속하는 클라이언트 수만큼 계속해서 쓰레드를 만들면, 운영 체제의 자원이 더 빨리 소진하게 된다.
- *즉, 서버는 동시 접속자가 많아지면서 쓰레드는 무한대로 생성되고, 이는 서버가 다운될 위험이 생긴다.*

따라서 애플리케이션 프로세스에서는 사용되고 있는 쓰레드의 개수를 관리하기 위한 ***“쓰레드 풀”*** 을 도입한다.

쓰레드 풀을 사용하게 되면 다음과 같은 장점을 가질 수 있다.

- ***자원 효율성***: 쓰레드 풀은 미리 **정해진** 개수의 쓰레드를 **생성 및 관리**한다.
    - 때문에 쓰레드 생성 및 삭제에 따른 오버헤드를 줄일 수 있다.
    - 이는 시스템 자원을 효율적으로 관리할 수 있고, 불필요한 자원 소모를 방지한다.
- ***응답성 및 처리량 향상***: 쓰레드 풀은 작업을 대기 상태로 유지하여 작업 처리 속도를 향상시킬 수 있다.
    - 즉, 작업 발생 시 대기 중인 쓰레드 중 하나를 선택해 작업을 할당해서 **병렬로 처리**할 수 있다.
- ***작업 제어***: 쓰레드 풀을 사용하면 동시에 처리할 수 있는 **작업의 개수를 제한**할 수 있다.
    - 즉, 쓰레드 풀의 크기를 조절해 시스템 부하를 조절하고, 과도한 작업 요청으로 성능 저하를 방지한다.
- ***쓰레드 관리***: 쓰레드 풀을 사용하면 쓰레드의 **생명 주기를 관리**할 수 있다.
    - 쓰레드 풀은 쓰레드의 생성, 재사용, 종료 등을 관리하여 쓰레드의 안전한 운영을 도와준다.

### Thread Pool 과 Connection Pool

---

WAS 에서 Thread Pool 과 Connection Pool 은 리소스 관리의 균형을 맞춰줘야 한다.

- Thread Pool과 Connection Pool 내에 있는 Thread와 Connection의 수는 메모리와 관련이 있다.
    - 때문에 많이 사용하면 할수록 많은 메모리를 점유하게 된다.
    - 반대로, 메모리를 적게 지정하면 서버에서는 많은 요청을 처리하지 못하고 대기하게 된다.

WAS 에서는 Thread의 수가 Connection의 수보다 많은 것이 좋다.

- 모든 요청이 데이터베이스로만 접근하는 작업이 아니기 때문이다.

## ⁉️ 면접 예상 질문: 동시 접속자가 많을 경우

### 클라이언트가 DB 요청 시, Pool 에 저장된 Connection 이 부족할 경우 어떻게 될까요?

---

만약, 모든 요청이 DB에 접근하고 있고 남은 Connection 이 없다면,

- 해당 클라이언트를 대기 상태로 전환시키고,
- Pool 에 Connection 이 반환되면, 대기 상태에 있는 클라이언트에게 번호 순으로 제공한다.