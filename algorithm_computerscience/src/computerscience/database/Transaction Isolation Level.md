## 🔜 트랜잭션 격리 수준

---

트랜잭션 격리 수준이란 동시에 여러 트랜잭션이 처리될 때, 트랜잭션끼리 얼마나 고립되어 있는가를 의미한다.

이는 트랜잭션의 ACID 특성과 같이 트랜잭션이 원자적이면서도 독립적인 수행을 하도록 하는데,

- 때문에 Locking이라는 개념이 등장하게 된다.
- Locking은 트랜잭션이 DB를 다루는 동안 다른 트랜잭션이 관여하지 못하게 막는 것을 의미한다.

하지만, 막연하게 접근할 수 없다라기 보다는 일반적인 접근 레벨이 존재하고, DB에 따라 설정할 수 있다.

- 즉, 무조건적인 Locking으로 동시에 수행되는 많은 트랜잭션들을 순서대로 처리하는 방식으로 구현되면, DB의 성능은 떨어지게 된다.
- 반대로 응답성을 높이기 위해 Locking 범위를 줄인다면, 잘못된 값이 처리될 여지가 있다.

### 격리성 레벨의 종류

---

트랜잭션 격리 수준은 Uncommited Read, Committed Read, Repeatable Read, Serializable이다.

**[ Read Uncommitted, 커밋되지 않은 읽기 - 레벨 0 ]**

<aside>
📌 트랜잭션에서 처리 중인, 아직 커밋되지 않은 데이터를 다른 트랜잭션이 읽는 것을 허용한다.

</aside>

---

- 즉, 커밋하지 않은 데이터를 읽을 수 있도록 허용한다.
- 발생 문제점: Dirty Read, Non-Repeatable Read, Phantom Read
- 해당 설정은 정합성에 문제가 있기 때문에 권장하는 설정은 아니다.
    - 하지만, 다른 격리성 수준에 비해 동시 처리 성능은 가장 높다.

**[ Read Committed, 커밋된 읽기 - 레벨 1 ]**

<aside>
📌 트랜잭션이 커밋되어 확정된 데이터만 다른 트랜잭션이 읽도록 허용한다.

</aside>

---

- 즉, 커밋이 완료된 데이터만 읽을 수 있도록 허용한다.
- 발생 문제점: Non-Repeatable Read, Phantom Read
- 커밋되지 않은 데이터에 대해서는 실제 DB 데이터가 아닌 UNDO 로그에 있는 이전 데이터를 가져오게 된다.
- Uncommitted Read 수준에 비해 동시 처리 성능은 떨어지나 Dirty Read가 발생할 가능성은 없다.

> 참고:
>

---

UNDO 로그는 MySQL, MariaDB에서 사용되는 InnoDB 스토리지 엔진은 트랜잭션이 롤백될 가능성에 대비해

변경되지 전 레코드를 UNDO 공간에 백업해두고 실제 레코드 값을 변경한다.

- 이러한 변경 방식을 MVCC라고 한다.

즉, Read-Uncommitted는 데이터 파일에서 데이터를 직접 읽어오고,

Read-Committed는 데이터 파일이 커밋되지 않은 데이터일 경우, UNDO에서 최신 UNDO 레코드를 읽어온다.

**[ Read Repeatable, 반복 가능한 읽기 - 레벨 2 ]**

<aside>
📌 트랜잭션 내에서 삭제, 변경에 대해서는 UNDO 로그에 넣어두고, 
앞서 발생한 트랜잭션에 대해서는 실제 데이터가 아닌 UNDO 로그에 있는 백업 데이터를 읽도록 한다.

</aside>

---

- 즉, 트랜잭션 내에서 한 번 조회한 데이터를 반복해서 조회해도 같은 같은 데이터가 조회된다.
- 따라서, 값의 변경에 대해 일정 값으로 처리할 수 있어 삭제와 수정에 대해 트랜잭션 내에서 불일치를 가져오면 Non-Repeatable 문제를 해결할 수 있다.
- 발생 문제점: Phantom Read

**[ Serializable, 직렬화가 가능 - 레벨 3 ]**

<aside>
📌 트랜잭션 내에서 쿼리를 두 번 이상 수행할 때, 첫 번째 쿼리에 있던 레코드가 사라지거나 값이 바뀌지 않음은 물론, 새로운 레코드가 나타나지 않도록 한다.

</aside>

---

- 가장 단순한 격리 수준이면서, 가장 엄격한 격리 수준으로 격리성으로 인해 발생할 수 있는 3가지 문제들을 모두 커버 가능하지만, 다른 트랜잭션 격리성 수준보다 동시 처리 성능은 현저히 떨어진다.
- 즉, 한 트랜잭션에서 읽고 쓰는 레코드를 다른 트랜잭션에서는 격리성 정의 그대로 절대 접근할 수 없기 때문에, 여러 트랜잭션이 줄서서 하나씩 처리된다.
- 따라서, 완벽한 읽기 일관성 모드를 제공하고, 다른 사용자는 그 영역에 해당되는 데이터에 대한 수정 및 입력이 불가능하다.

**[ 낮은 단계의 격리 레벨 이용 시 발생하는 현상 ]**

- Dirty Read:
    - 커밋되지 않은 수정 중인 데이터를 다른 트랜잭션에서 읽을 수 있도록 허용할 때 발생하는 현상이다.
    - 어떤 트랜잭션에서 아직 실행이 끝나지 않은 트랜잭션에 의한 변경 사항을 보게 되는 경우이다.
- Non-Repeatable Read:
    - 한 트랜잭션에서 같은 쿼리를 두 번 수행할 때, 그 사이에 다른 트랜잭션이 값을 수정 또는 삭제함으로써 두 쿼리의 결과가 상이하게 나타나는 비 일관성 현상이다.
- Phantom Read:
    - 한 트랜잭션 안에서 일정 범위의 레코드를 두 번 이상 읽을 때, 첫 번째 쿼리에서 없던 레코드가 두 번째 쿼리에서 나타나는 현상이다.
    - 이는 트랜잭션 도중 새로운 레코드가 삽입되는 것을 허용하기 때문에 나타난다.

> 정리:
>

---

- 격리 레벨 조정은 동시성이 증가되는데 반해 데이터 무결성에 문제가 발생할 수 있고,
- 데이터의 무결성을 유지하는 데 반해 동시성이 떨어질 수 있다.
- 또한, 레벨이 높아질수록 비용이 높아진다.